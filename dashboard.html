<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrataSoft Dashboard</title>
<style>
    body { margin:0; font-family:'Segoe UI', sans-serif; background:#f4f6f9; }
    #dashboard { display:flex; height:100vh; }
    .sidebar { width:220px; background:#1d3557; color:white; padding:20px 10px; }
    .sidebar h2 { text-align:center; margin-bottom:30px; }
    .sidebar ul { list-style:none; padding:0; }
    .sidebar ul li { padding:10px; cursor:pointer; border-radius:5px; margin-bottom:5px; }
    .sidebar ul li.active, .sidebar ul li:hover { background:#457b9d; }
    .main { flex:1; padding:20px; display:flex; flex-direction:column; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .topbar button.logout { background:#e63946; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; }
    .cards { display:flex; gap:10px; margin-bottom:20px; }
    .card { flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; }
    .liveCard { background:#a8dadc; }
    .downCard { background:#f08080; }
    .controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
    #adminTools { display:none; gap:5px; }
    #adminTools input, #adminTools select { padding:5px; border-radius:4px; border:1px solid #ccc; }
    .tableBox { overflow:auto; flex:1; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#457b9d; color:white; }
    td.live { color:green; font-weight:bold; }
    td.down { color:red; font-weight:bold; }
    .edit-input { width:100%; padding:4px; border-radius:3px; border:1px solid #aaa; }
    .del-btn { background:#e63946; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>

<div id="dashboard">
    <div class="sidebar">
        <h2>TrataSoft</h2>
        <ul>
            <li id="monBtn" class="active" onclick="toggleView('monitor')">View Monitoring</li>
            <li id="editBtn" onclick="toggleView('edit')">Settings / Edit</li>
        </ul>
    </div>

    <div class="main">
        <div class="topbar">
            <h2 id="viewTitle">Live Monitoring</h2>
            <button class="logout" onclick="logout()">Logout</button>
        </div>

        <div class="cards">
            <div class="card"><h3>Total Sites</h3><p id="totalCount">0</p></div>
            <div class="card liveCard"><h3>Live</h3><p id="liveCount">0</p></div>
            <div class="card downCard"><h3>Down</h3><p id="downCount">0</p></div>
        </div>

        <div class="controls">
            <div id="adminTools">
                <input type="text" id="newName" placeholder="Company Name">
                <input type="text" id="newUrl" placeholder="Website URL">
                <select id="newNetwork">
                    <option value="">Select Network Type</option>
                    <option value="LAN">LAN</option>
                    <option value="Wi-Fi">Wi-Fi</option>
                    <option value="COFE CF-4G007e">COFE CF-4G007e</option>
                </select>
                <button onclick="addWebsite()">Add New</button>
            </div>

            <select id="filter" onchange="renderTable()">
                <option value="all">Filter: All</option>
                <option value="live">Live</option>
                <option value="down">Down</option>
            </select>
            <input type="text" id="search" placeholder="Search site..." onkeyup="renderTable()">
        </div>

        <div class="tableBox">
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Website</th>
                        <th>Network</th>
                        <th>Status</th>
                        <th id="actionHeader" style="display:none;">Action</th>
                    </tr>
                </thead>
                <tbody id="websiteTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1I7uggV3I8Z7pmbpWQmJZO_mHlWQ7qRc",
  authDomain: "aitdata-1f856.firebaseapp.com",
  databaseURL: "https://aitdata-1f856-default-rtdb.firebaseio.com",
  projectId: "aitdata-1f856",
  storageBucket: "aitdata-1f856.firebasestorage.app",
  messagingSenderId: "535350785851",
  appId: "1:535350785851:web:67abe23a6da1dca7fe291e",
  measurementId: "G-82Y1DL677C"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, 'websites');

if(localStorage.getItem("loggedIn") !== "true") window.location.href = "index.html";

let websites = [];
let isEditMode = false;

// Load websites from Firebase
async function loadWebsites() {
    try {
        const snapshot = await get(dbRef);
        if(snapshot.exists()) {
            websites = Object.values(snapshot.val());
        } else {
            // First-time: populate 700 entries
            for(let i = 1; i <= 700; i++){
                let num = i.toString().padStart(3,'0');
                websites.push({
                    name: "TrataSoft " + num,
                    url: "https://trtdlaita" + num + ".tratasoft.com/login",
                    status: "checking",
                    networkType: "LAN"
                });
            }
            saveData();
        }
        renderTable();
    } catch (error) {
        console.error("Error loading websites:", error);
    }
}
loadWebsites();

function logout() { localStorage.removeItem("loggedIn"); window.location.href = "index.html"; }

function saveData() {
    const updates = {};
    websites.forEach((site, index) => { updates[index] = site; });
    set(dbRef, updates)
        .then(() => alert("Changes Saved Successfully!"))
        .catch(err => alert("Error saving: " + err));
}

function toggleView(mode) {
    isEditMode = (mode === 'edit');
    document.getElementById('adminTools').style.display = isEditMode ? "flex" : "none";
    document.getElementById('actionHeader').style.display = isEditMode ? "table-cell" : "none";
    document.getElementById('viewTitle').innerText = isEditMode ? "Management Mode" : "Live Monitoring";
    document.getElementById('editBtn').classList.toggle('active', isEditMode);
    document.getElementById('monBtn').classList.toggle('active', !isEditMode);

    if(isEditMode && !document.getElementById("saveBtn")){
        let btn = document.createElement("button");
        btn.id = "saveBtn";
        btn.innerText = "Save Changes";
        btn.onclick = saveData;
        btn.style.marginLeft = "10px";
        document.querySelector(".controls").appendChild(btn);
    } else if(!isEditMode){
        let btn = document.getElementById("saveBtn");
        if(btn) btn.remove();
    }
    renderTable();
}

function addWebsite() {
    const name = document.getElementById("newName").value;
    const url = document.getElementById("newUrl").value;
    const network = document.getElementById("newNetwork").value;
    if(!name || !url || !network) return alert("Fill all fields");
    websites.push({ name, url, status:"checking", networkType:network });
    saveData();
    document.getElementById("newName").value = "";
    document.getElementById("newUrl").value = "";
    document.getElementById("newNetwork").value = "";
    renderTable();
}

function deleteWebsite(index) {
    if(confirm("Delete this entry?")) {
        websites.splice(index,1);
        saveData();
        renderTable();
    }
}

function renderTable() {
    const filterValue = document.getElementById("filter").value;
    const searchValue = document.getElementById("search").value.toLowerCase();
    const tableBody = document.getElementById("websiteTable");
    tableBody.innerHTML = "";

    websites.forEach((site,index) => {
        if(filterValue!=="all" && site.status!==filterValue) return;
        if(!site.name.toLowerCase().includes(searchValue) && !site.url.toLowerCase().includes(searchValue)) return;

        const row = document.createElement("tr");

        const nameCell = isEditMode ? `<input class="edit-input" value="${site.name}" onchange="websites[${index}].name=this.value">` : site.name;
        const urlCell = isEditMode ? `<input class="edit-input" value="${site.url}" onchange="websites[${index}].url=this.value">` : `<a href="${site.url}" target="_blank">${site.url}</a>`;
        const networkCell = isEditMode ? `<select class="edit-input" onchange="websites[${index}].networkType=this.value">
            <option value='LAN' ${site.networkType==='LAN'?'selected':''}>LAN</option>
            <option value='Wi-Fi' ${site.networkType==='Wi-Fi'?'selected':''}>Wi-Fi</option>
            <option value='COFE CF-4G007e' ${site.networkType==='COFE CF-4G007e'?'selected':''}>COFE CF-4G007e</option>
        </select>` : site.networkType;

        const actionCell = isEditMode ? `<td><button class="del-btn" onclick="deleteWebsite(${index})">Delete</button></td>` : "";

        row.innerHTML = `<td>${nameCell}</td><td>${urlCell}</td><td>${networkCell}</td><td id="status-${index}" class="${site.status}">${site.status.toUpperCase()}</td>${actionCell}`;
        tableBody.appendChild(row);

        checkStatus(site.url,index);
    });

    updateCounters();
}

function updateCounters() {
    document.getElementById("totalCount").innerText = websites.length;
    document.getElementById("liveCount").innerText = websites.filter(s=>s.status==="live").length;
    document.getElementById("downCount").innerText = websites.filter(s=>s.status==="down").length;
}

function checkStatus(url,index){
    fetch(url,{mode:'no-cors'})
        .then(()=>{ websites[index].status="live"; const cell=document.getElementById("status-"+index); if(cell){cell.innerText="LIVE";cell.className="live";} })
        .catch(()=>{ websites[index].status="down"; const cell=document.getElementById("status-"+index); if(cell){cell.innerText="DOWN";cell.className="down";} });
}

setInterval(()=>{ websites.forEach((site,index)=>checkStatus(site.url,index)); updateCounters(); },30000);
</script>

</body>
</html>
