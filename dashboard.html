<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrataSoft Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="dashboard">
    <div class="sidebar">
        <h2>TrataSoft</h2>
        <ul>
            <li id="monBtn" class="active" onclick="toggleView('monitor')">View Monitoring</li>
            <li id="editBtn" onclick="toggleView('edit')">Settings / Edit</li>
        </ul>
    </div>

    <div class="main">
        <div class="topbar">
            <h2 id="viewTitle">Live Monitoring</h2>
            <button class="logout" onclick="logout()">Logout</button>
        </div>

        <div class="cards">
            <div class="card"><h3>Total Sites</h3><p id="totalCount">0</p></div>
            <div class="card liveCard"><h3>Live</h3><p id="liveCount">0</p></div>
            <div class="card downCard"><h3>Down</h3><p id="downCount">0</p></div>
        </div>

        <div class="controls">
            <div id="adminTools" style="display:none;">
                <input type="text" id="newName" placeholder="Company Name">
                <input type="text" id="newUrl" placeholder="Website URL">
                <select id="newNetwork">
                    <option value="">Select Network Type</option>
                    <option value="LAN">LAN</option>
                    <option value="Wi-Fi">Wi-Fi</option>
                    <option value="COFE CF-4G007e">COFE CF-4G007e</option>
                </select>
                <button onclick="addWebsite()">Add New</button>
            </div>
        </div>

        <div class="tableBox">
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Website</th>
                        <th>Network</th>
                        <th>Status</th>
                        <th id="actionHeader" style="display:none;">Action</th>
                    </tr>
                </thead>
                <tbody id="websiteTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  deleteDoc, 
  doc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDKtHixAqtV7mt3rLG6O40cD5sag_PPT-4",
  authDomain: "aitdata.firebaseapp.com",
  projectId: "aitdata",
  storageBucket: "aitdata.firebasestorage.app",
  messagingSenderId: "1086041126338",
  appId: "1:1086041126338:web:71fdfaa5ff41218ec1525b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let websites = [];
let isEditMode = false;

/* üîê Login Check */
if(localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
}

window.logout = function() {
    localStorage.removeItem("loggedIn");
    window.location.href = "index.html";
};

/* üì• Load Data */
async function loadWebsites() {
    websites = [];
    const snapshot = await getDocs(collection(db, "websites"));
    snapshot.forEach(docSnap => {
        websites.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderTable();
}

/* ‚ûï Add Website */
window.addWebsite = async function() {
    const name = document.getElementById("newName").value;
    const url = document.getElementById("newUrl").value;
    const network = document.getElementById("newNetwork").value;

    if(!name || !url || !network) return alert("Fill all fields");

    await addDoc(collection(db, "websites"), {
        name,
        url,
        networkType: network,
        status: "checking"
    });

    document.getElementById("newName").value = "";
    document.getElementById("newUrl").value = "";
    document.getElementById("newNetwork").value = "";

    loadWebsites();
};

/* ‚ùå Delete Website */
window.deleteWebsite = async function(id) {
    if(confirm("Delete this entry?")) {
        await deleteDoc(doc(db, "websites", id));
        loadWebsites();
    }
};

/* üîÑ Toggle Mode */
window.toggleView = function(mode) {
    isEditMode = (mode === 'edit');
    document.getElementById('adminTools').style.display = isEditMode ? "block" : "none";
    document.getElementById('actionHeader').style.display = isEditMode ? "table-cell" : "none";
    document.getElementById('viewTitle').innerText = isEditMode ? "Management Mode" : "Live Monitoring";
    renderTable();
};

/* üìä Render Table */
function renderTable() {
    const tableBody = document.getElementById("websiteTable");
    tableBody.innerHTML = "";

    websites.forEach(site => {

        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${site.name}</td>
            <td><a href="${site.url}" target="_blank">${site.url}</a></td>
            <td>${site.networkType}</td>
            <td id="status-${site.id}">${site.status || "checking"}</td>
            ${isEditMode ? `<td><button onclick="deleteWebsite('${site.id}')">Delete</button></td>` : ""}
        `;

        tableBody.appendChild(row);

        checkStatus(site.url, site.id);
    });

    updateCounters();
}

/* üåê Check Website Status */
function checkStatus(url, id) {
    fetch(url, { mode: 'no-cors' })
    .then(() => {
        document.getElementById("status-"+id).innerText = "LIVE";
    })
    .catch(() => {
        document.getElementById("status-"+id).innerText = "DOWN";
    });
}

/* üî¢ Counters */
function updateCounters() {
    document.getElementById("totalCount").innerText = websites.length;
}

/* ‚è≥ Auto Refresh */
setInterval(loadWebsites, 30000);

/* üöÄ Start */
loadWebsites();

</script>
</body>
</html>
