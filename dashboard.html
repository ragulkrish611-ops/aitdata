<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrataSoft Dashboard</title>
</head>
<body>

<div id="dashboard">
  <div class="sidebar">
    <h2>TrataSoft</h2>
    <ul>
      <li id="monBtn" class="active">View Monitoring</li>
      <li id="editBtn">Settings / Edit</li>
    </ul>
  </div>

  <div class="main">
    <div class="topbar">
      <h2 id="viewTitle">Live Monitoring</h2>
      <button id="logoutBtn">Logout</button>
    </div>

    <div class="cards">
      <div class="card"><h3>Total Sites</h3><p id="totalCount">0</p></div>
      <div class="card liveCard"><h3>Live</h3><p id="liveCount">0</p></div>
      <div class="card downCard"><h3>Down</h3><p id="downCount">0</p></div>
    </div>

    <div class="controls">
      <div id="adminTools">
        <input type="text" id="newName" placeholder="Company Name">
        <input type="text" id="newUrl" placeholder="Website URL">
        <select id="newNetwork">
          <option value="">Select Network Type</option>
          <option value="LAN">LAN</option>
          <option value="Wi-Fi">Wi-Fi</option>
          <option value="COFE CF-4G007e">COFE CF-4G007e</option>
        </select>
        <button id="addBtn">Add New</button>
      </div>

      <select id="filter">
        <option value="all">Filter: All</option>
        <option value="live">Live</option>
        <option value="down">Down</option>
      </select>
      <input type="text" id="search" placeholder="Search site...">
    </div>

    <div class="tableBox">
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th>Website</th>
            <th>Network</th>
            <th>Status</th>
            <th id="actionHeader" style="display:none;">Action</th>
          </tr>
        </thead>
        <tbody id="websiteTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
// ==== Firebase SDK ====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyC1I7uggV3I8Z7pmbpWQmJZO_mHlWQ7qRc",
  authDomain:"aitdata-1f856.firebaseapp.com",
  databaseURL:"https://aitdata-1f856-default-rtdb.firebaseio.com",
  projectId:"aitdata-1f856",
  storageBucket:"aitdata-1f856.firebasestorage.app",
  messagingSenderId:"535350785851",
  appId:"1:535350785851:web:67abe23a6da1dca7fe291e",
  measurementId:"G-82Y1DL677C"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db,"websiteData");

// ==== Local Storage Login check ====
if(localStorage.getItem("loggedIn")!=="true") window.location.href="index.html";

let websites = [];
let isEditMode = false;

// ==== Load Websites from Firebase ====
async function loadWebsites(){
  const snapshot = await get(dbRef);
  if(snapshot.exists()) websites = Object.values(snapshot.val());
  else {
    for(let i=1;i<=700;i++){
      let num=i.toString().padStart(3,'0');
      websites.push({name:"TrataSoft "+num,url:"https://trtdlaita"+num+".tratasoft.com/login",status:"checking",networkType:"LAN"});
    }
    saveData();
  }
  initDashboard();
}

// ==== Save Data to Firebase ====
function saveData(){
  const updates={}; websites.forEach((s,i)=>updates[i]=s);
  set(dbRef,updates).catch(e=>alert(e));
}

loadWebsites();

// ==== Initialize Dashboard ====
function initDashboard(){
  const monBtn=document.getElementById("monBtn");
  const editBtn=document.getElementById("editBtn");
  const logoutBtn=document.getElementById("logoutBtn");
  const addBtn=document.getElementById("addBtn");
  const filter=document.getElementById("filter");
  const search=document.getElementById("search");

  monBtn.onclick=()=>toggleView('monitor');
  editBtn.onclick=()=>toggleView('edit');
  logoutBtn.onclick=()=>{localStorage.removeItem("loggedIn"); window.location.href="index.html";};
  addBtn.onclick=addWebsite;
  filter.onchange=renderTable;
  search.onkeyup=renderTable;

  function toggleView(mode){
    isEditMode=(mode==='edit');
    document.getElementById('adminTools').style.display=isEditMode?"block":"none";
    document.getElementById('actionHeader').style.display=isEditMode?"table-cell":"none";
    document.getElementById('viewTitle').innerText=isEditMode?"Management Mode":"Live Monitoring";
    editBtn.classList.toggle('active',isEditMode);
    monBtn.classList.toggle('active',!isEditMode);
    renderTable();
  }

  function addWebsite(){
    const name=document.getElementById("newName").value;
    const url=document.getElementById("newUrl").value;
    const network=document.getElementById("newNetwork").value;
    if(!name||!url||!network)return alert("Fill all fields");
    websites.push({name,url,status:"checking",networkType:network});
    saveData();
    document.getElementById("newName").value="";
    document.getElementById("newUrl").value="";
    document.getElementById("newNetwork").value="";
    renderTable();
  }

  window.deleteWebsite=function(index){
    if(confirm("Delete this entry?")){
      websites.splice(index,1);
      saveData();
      renderTable();
    }
  }

  function renderTable(){
    const f=filter.value, s=search.value.toLowerCase(), tbody=document.getElementById("websiteTable");
    tbody.innerHTML="";
    websites.forEach((site,i)=>{
      if(f!=="all" && site.status!==f) return;
      if(!site.name.toLowerCase().includes(s) && !site.url.toLowerCase().includes(s)) return;

      const row=document.createElement("tr");

      const nameCell=document.createElement("td");
      if(isEditMode){
        const input=document.createElement("input"); input.value=site.name;
        input.onchange=()=>{websites[i].name=input.value; saveData();}
        nameCell.appendChild(input);
      } else nameCell.innerText=site.name;

      const urlCell=document.createElement("td");
      if(isEditMode){
        const input=document.createElement("input"); input.value=site.url;
        input.onchange=()=>{websites[i].url=input.value; saveData();}
        urlCell.appendChild(input);
      } else { const a=document.createElement("a"); a.href=site.url; a.target="_blank"; a.innerText=site.url; urlCell.appendChild(a); }

      const networkCell=document.createElement("td");
      if(isEditMode){
        const select=document.createElement("select");
        ["LAN","Wi-Fi","COFE CF-4G007e"].forEach(opt=>{
          const o=document.createElement("option"); o.value=opt; o.text=opt;
          if(site.networkType===opt) o.selected=true;
          select.appendChild(o);
        });
        select.onchange=()=>{websites[i].networkType=select.value; saveData();}
        networkCell.appendChild(select);
      } else networkCell.innerText=site.networkType;

      const statusCell=document.createElement("td");
      statusCell.id="status-"+i; statusCell.innerText=site.status.toUpperCase();

      const actionCell=document.createElement("td"); actionCell.style.display=isEditMode?"table-cell":"none";
      if(isEditMode){ const btn=document.createElement("button"); btn.innerText="Delete"; btn.onclick=()=>deleteWebsite(i); actionCell.appendChild(btn); }

      row.appendChild(nameCell); row.appendChild(urlCell); row.appendChild(networkCell); row.appendChild(statusCell); row.appendChild(actionCell);
      tbody.appendChild(row);

      checkStatus(site.url,i);
    });
    updateCounters();
  }

  function updateCounters(){
    document.getElementById("totalCount").innerText=websites.length;
    document.getElementById("liveCount").innerText=websites.filter(s=>s.status==="live").length;
    document.getElementById("downCount").innerText=websites.filter(s=>s.status==="down").length;
  }

  function checkStatus(url,i){
    fetch(url,{mode:'no-cors'}).then(()=>{websites[i].status="live"; const c=document.getElementById("status-"+i); if(c){c.innerText="LIVE";}})
    .catch(()=>{websites[i].status="down"; const c=document.getElementById("status-"+i); if(c){c.innerText="DOWN";}});
  }

  setInterval(()=>{websites.forEach((site,i)=>checkStatus(site.url,i)); updateCounters();},30000);
}

</script>

</body>
</html>
