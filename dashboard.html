<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrataSoft Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="dashboard">
    <div class="sidebar">
        <h2>TrataSoft</h2>
        <ul>
            <li id="monBtn" class="active" onclick="toggleView('monitor')">View Monitoring</li>
            <li id="editBtn" onclick="toggleView('edit')">Settings / Edit</li>
        </ul>
    </div>

    <div class="main">
        <div class="topbar">
            <h2 id="viewTitle">Live Monitoring</h2>
            <button class="logout" id="logoutBtn">Logout</button>
        </div>

        <div class="cards">
            <div class="card"><h3>Total Sites</h3><p id="totalCount">0</p></div>
            <div class="card liveCard"><h3>Live</h3><p id="liveCount">0</p></div>
            <div class="card downCard"><h3>Down</h3><p id="downCount">0</p></div>
        </div>

        <div class="controls">
            <div id="adminTools" style="display:none;">
                <input type="text" id="newName" placeholder="Company Name">
                <input type="text" id="newUrl" placeholder="Website URL">
                <select id="newNetwork">
                    <option value="">Select Network Type</option>
                    <option value="LAN">LAN</option>
                    <option value="Wi-Fi">Wi-Fi</option>
                    <option value="COFE CF-4G007e">COFE CF-4G007e</option>
                </select>
                <button id="addBtn">Add New</button>
            </div>
        </div>

        <div class="tableBox">
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Website</th>
                        <th>Network</th>
                        <th>Status</th>
                        <th id="actionHeader" style="display:none;">Action</th>
                    </tr>
                </thead>
                <tbody id="websiteTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  deleteDoc, 
  doc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDKtHixAqtV7mt3rLG6O40cD5sag_PPT-4",
  authDomain: "aitdata.firebaseapp.com",
  projectId: "aitdata",
  storageBucket: "aitdata.firebasestorage.app",
  messagingSenderId: "1086041126338",
  appId: "1:1086041126338:web:71fdfaa5ff41218ec1525b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const functions = getFunctions(app);
const checkStatusFunc = httpsCallable(functions, "checkWebsiteStatus");

let websites = [];
let isEditMode = false;

/* Login Check */
if(localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
}

/* Logout */
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("loggedIn");
    window.location.href = "index.html";
});

/* Load Websites */
async function loadWebsites() {
    websites = [];
    const snapshot = await getDocs(collection(db, "websites"));
    snapshot.forEach(docSnap => {
        websites.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderTable();
}

/* Add Website */
document.getElementById("addBtn").addEventListener("click", async () => {
    const name = document.getElementById("newName").value;
    const url = document.getElementById("newUrl").value;
    const network = document.getElementById("newNetwork").value;
    if(!name || !url || !network) return alert("Fill all fields");

    await addDoc(collection(db, "websites"), {
        name, url, networkType: network
    });
    document.getElementById("newName").value = "";
    document.getElementById("newUrl").value = "";
    document.getElementById("newNetwork").value = "";
    loadWebsites();
});

/* Delete */
window.deleteWebsite = async function(id) {
    if(confirm("Delete this entry?")) {
        await deleteDoc(doc(db, "websites", id));
        loadWebsites();
    }
};

/* Toggle View */
window.toggleView = function(mode) {
    isEditMode = (mode === 'edit');
    document.getElementById('adminTools').style.display = isEditMode ? "block" : "none";
    document.getElementById('actionHeader').style.display = isEditMode ? "table-cell" : "none";
    document.getElementById('viewTitle').innerText = isEditMode ? "Management Mode" : "Live Monitoring";
    renderTable();
};

/* Render Table */
function renderTable() {
    const tableBody = document.getElementById("websiteTable");
    tableBody.innerHTML = "";
    websites.forEach(site => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${site.name}</td>
            <td><a href="${site.url}" target="_blank">${site.url}</a></td>
            <td>${site.networkType}</td>
            <td id="status-${site.id}">Checking...</td>
            ${isEditMode ? `<td><button onclick="deleteWebsite('${site.id}')">Delete</button></td>` : ""}
        `;
        tableBody.appendChild(row);
        checkSiteStatus(site.url, site.id);
    });
    updateCounters();
}

/* Check Status via Cloud Function */
async function checkSiteStatus(url, id) {
    try {
        const res = await checkStatusFunc({ url });
        document.getElementById("status-" + id).innerText = res.data.status;
    } catch (e) {
        document.getElementById("status-" + id).innerText = "DOWN";
    }
}

/* Update Counters */
function updateCounters() {
    const total = websites.length;
    let live = 0, down = 0;
    websites.forEach(site => {
        const st = document.getElementById("status-" + site.id)?.innerText;
        if(st === "LIVE") live++;
        if(st === "DOWN") down++;
    });
    document.getElementById("totalCount").innerText = total;
    document.getElementById("liveCount").innerText = live;
    document.getElementById("downCount").innerText = down;
}

loadWebsites();
</script>
</body>
</html>
